---
title: "Getting started with climecol"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Getting started with climecol}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 7, fig.height = 4.2,
  message = FALSE, warning = FALSE
)
```

# Why climecol?

`climecol` provides a lightweight, reproducible workflow for archiving, analyzing, and visualizing weather and climate data in ecological and infectious-disease modeling contexts.

It includes:

- Curated daily weather data (Newfoundland example dataset)
- Fast, dependency-free photoperiod (daylength) functions
- Simple tools for quality checks, gap handling, and plotting
- Functions designed for offline and reproducible pipelines

## Installation

```{r, eval=FALSE}
# install.packages("devtools")
devtools::install_github("jbaafi/climecol")
```

Then load the package:

```{r}
library(climecol)
```

## Loading and validating weather data

You can import and validate your weather data from a .csv file as follows:

```{r, eval=FALSE}
wx <- read_weather_csv("data-raw/combined_data.csv")
wx <- normalize_weather_names(wx)

qa <- validate_weather(wx, temp_bounds = c(-50, 50), rain_max = 150, snow_max = 60)
qa$summary

```

The validate_weather() summary reports:

- record span (span_start, span_end)
- missing days, out-of-bounds temperature values
- and unrealistic rainfall/snow totals flagged during checks.


## Photoperiod (daylength)

The package implements the Forsythe et al. (1995) solar-geometry approximation to compute daylength (in hours) using only date and latitude, no timezone or longitude required.

Example: daily photoperiod

```{r}
pp_nl <- photoperiod_year(2024, location = "St John's")
head(pp_nl)
```

Quick plot:

```{r}
plot(pp_nl$date, pp_nl$daylength_hours, type = "l",
     xlab = "date", ylab = "Daylength (hours)",
     main = "Photoperiod — St. John's, NL (2024)")
```

Monthly means and multi-site comparison

```{r}
pp_nl_m <- photoperiod_year(2024, location = "St John's",  aggregate = "month")
pp_nb_m <- photoperiod_year(2024, location = "Saint John", aggregate = "month")
head(pp_nl_m)
head(pp_nb_m)
```

> Tip: Site names are case-insensitive and punctuation-agnostic.

> `"St John's"`, `"st_johns"`, `"St.Johns"` → `st_johns` (NL); 
`"Saint John"` / `"st john"` → `saint_john` (NB).  

> If you provide a numeric latitude instead of location, results are labeled lat_<value>.


## Example dataset: Newfoundland (2008–2023)

`climecol` ships daily weather dataset for Newfoundland and Labrador.

```{r}
data(weather_nl)

library(dplyr)
glimpse(weather_nl)
```

Normalize column names for consistency:

```{r}
df <- normalize_weather_names(weather_nl)
```


## Quick rainfall visualization

```{r}
plot_rainfall(df)
```

To facet by year:

```{r}
plot_rainfall(df, facet_by_year = TRUE)
```


## Exploring rainfall summaries

Monthly rainfall totals

```{r}
library(dplyr)

df <- normalize_weather_names(weather_nl)

df <- summarise_rainfall_monthly(df)
head(df)
```


## Exporting data

Save any computed or fitted data to CSV for modeling or sharing:

```{r}
out_file <- file.path(tempdir(), "photoperiod_st_johns_2024.csv")
write.csv(pp_nl, out_file, row.names = FALSE)
out_file
```

> The file is written to a temporary directory during vignette build. Replace tempdir() with your project path in real workflows.


## Seasonal climatology: sinusoidal fits

The function `fit_seasonal_temp()` estimates smooth seasonal temperature cycles using sinusoidal functions (e.g., sin1, sin2).

```{r}
fit_out <- fit_seasonal_temp(weather_nl, funcs = c("sin1","sin2"), plot = TRUE)

knitr::kable(fit_out$metrics, digits = 3, caption = "Model comparison by AIC and R²")

if (!is.null(fit_out$plot)) fit_out$plot
```


## Extending temperature fits with custom models

You can also define your own models using nonlinear formulas.

```{r}
# Standardize column names
df <- normalize_weather_names(weather_nl)

# Define your custom model (formula uses mean_temp ~ ... and day_of_year)
custom_models <- list(
  quad = list(
    formula = mean_temp ~ a + b * day_of_year + c * I(day_of_year^2),
    start   = list(a = mean(df$tavg_c, na.rm = TRUE), b = 0, c = 0)  # <- REQUIRED
  )
)

# Fit: built-ins via `funcs=`, user models via `custom=`
res <- fit_seasonal_temp(
  df,
  funcs  = "sin1",     # optional: keep a built-in for comparison
  custom = custom_models,
  plot   = TRUE
)

# Results
res$metrics   # AIC and R2 per model
res$plot      # overlay plot
```


## Seasonal photoperiod fitting

Analogously, you can fit smooth periodic functions to average daylength:

```{r}
res <- fit_seasonal_photo(
  location = "St John's",
  years = c(2023, 2024),
  funcs = c("sin1","sin2"),
  plot = TRUE
)
res$metrics
res$plot
```

Custom models are also supported:

```{r}
res_custom <- fit_seasonal_photo(
  location = "St John's",
  years = c(2023, 2024),
  funcs = "sin1",
  custom = list(
    cos1 = list(
      formula = avg_photo ~ a + b * cos(2*pi*day_of_year/365),
      start   = list(a = 12, b = 6)
    )
  )
)
res_custom$metrics
```


## Key functions at a glance

| Category | Function | Purpose |
|-----------|-----------|----------|
| **Import / Validation** | `read_weather_csv()`, `validate_weather()` | Read and quality-check weather data |
| **Standardization** | `normalize_weather_names()` | Harmonize column names across datasets |
| **Gap handling** | `complete_daily_calendar()`, `summarise_gaps()`, `impute_weather()` | Detect and fill missing dates/values |
| **Photoperiod** | `daylength_f95()`, `photoperiod_year()`, `photoperiod_sites()` | Compute daylight hours from date and latitude |
| **Climate fitting** | `fit_seasonal_temp()`, `fit_seasonal_photo()` | Fit sinusoidal seasonal models for temperature or daylength |
| **Rainfall simulation** | `sample_rainfall_by_month()`, `simulate_rainfall_scenarios()` | Generate stochastic rainfall or scenario time series |
| **Visualization** | `plot_rainfall()` | Plot daily or multi-year rainfall with optional yearly facets |
| **Export** | `export_weather()` | Save validated or imputed data to CSV for modeling |


## References

> Forsythe, W. C., Rykiel, E. J., Stahl, R. S., Wu, H., & Schoolfield, R. M. (1995).  
> *A model comparison for daylength as a function of latitude and day of year.* Ecological Modelling, 80, 87–95.

## Session info

```{r session-info, eval=FALSE}
sessionInfo()
```

